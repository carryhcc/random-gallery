<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºå›¾åº“ - ä¸“ä¸šå›¾ç‰‡æµè§ˆå¹³å°</title>

    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="éšæœºå›¾åº“">

    <!-- iOS å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">

    <!-- Android Chrome -->
    <link rel="icon" type="image/x-icon" sizes="192x192" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/theme.js"></script>
    <style>
        .theme-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 1030;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-primary);
            font-size: var(--font-size-lg);
        }

        .theme-toggle:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-hover);
            transform: scale(1.05);
        }

        .theme-toggle i {
            transition: transform var(--transition-base);
        }

        .theme-toggle:hover i {
            transform: rotate(180deg);
        }

        /* Disabled state for action cards */
        .action-card.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /* --- æ–°ç‰ˆå¸ƒå±€æ ·å¼ --- */
        .main-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.5rem;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
        }

        .module-card {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            min-height: 100%;
        }

        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-subtitle {
            text-align: left;
            margin: 0;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            padding-left: 2rem;
            /* Align with title text */
        }

        /* ç¯å¢ƒç»Ÿè®¡ */
        .env-stats {
            padding-left: 2rem;
            text-align: left;
            margin: 0;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        /* æŒ‰é’®ç½‘æ ¼ */
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* åŠ¨ä½œå¡ç‰‡æŒ‰é’® */
        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1.5rem 1rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            text-decoration: none;
            color: var(--color-text-primary);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: var(--color-primary);
        }

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(102, 126, 234, 0.1);
            color: var(--color-primary);
            transition: all var(--transition-fast);
        }

        .action-card:hover .icon-box {
            transform: scale(1.1);
        }

        /* é¢œè‰²å˜ä½“ */
        .action-card.warm .icon-box {
            background: rgba(255, 159, 67, 0.1);
            color: #ff9f43;
        }

        .action-card.accent .icon-box {
            background: rgba(238, 82, 83, 0.1);
            color: #ee5253;
        }

        .action-card.neutral .icon-box {
            background: rgba(84, 160, 255, 0.1);
            color: #54a0ff;
        }

        .action-card.success .icon-box {
            background: rgba(16, 172, 132, 0.1);
            color: #10ac84;
        }

        .action-card.info .icon-box {
            background: rgba(46, 134, 222, 0.1);
            color: #2e86de;
        }

        .action-card.warning .icon-box {
            background: rgba(255, 177, 66, 0.1);
            color: #ffb142;
        }

        .label {
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* ç¯å¢ƒåˆ‡æ¢å™¨ (Compact) */
        .env-selector {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--color-bg-tertiary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            border: 1px solid var(--color-border);
            transition: all 0.2s ease;
        }

        .env-selector:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-hover);
        }

        .env-badge {
            font-weight: 600;
            color: var(--color-primary);
        }

        .env-selector .fa-chevron-down {
            transition: transform 0.2s ease;
            font-size: 0.8em;
            color: var(--color-text-tertiary);
        }

        .env-selector.active .fa-chevron-down {
            transform: rotate(180deg);
        }

        .env-dropdown-list {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            left: auto !important;
            /* Force override style.css left: 0 */
            width: 140px;
            background: var(--color-bg-overlay);
            /* Semi-transparent for blur */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 2000;
            padding: 6px;

            /* Initial State */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .env-selector.active .env-dropdown-list {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .env-dropdown-option {
            padding: 8px 12px;
            text-decoration: none;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            transition: all 0.2s;
            text-align: left;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .env-dropdown-option:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }

        .env-dropdown-option.active {
            background: var(--color-primary-bg);
            color: var(--color-primary);
            font-weight: 500;
        }

        /* éšç§æ¨¡å¼æŒ‰é’® */
        .privacy-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--color-border);
            border-radius: 20px;
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .privacy-btn:hover {
            background: var(--color-bg-hover);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 0.5rem;
            }

            .button-grid {
                gap: 0.75rem;
            }

            .action-card {
                padding: 1.25rem 0.75rem;
            }
        }
    </style>
</head>

<body>

    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">

        <!-- æ¨¡å—ä¸€ï¼šæœ¬åœ°å›¾åº“ -->
        <div class="card module-card animate-fade-in">
            <div class="card-header">
                <div class="header-main">
                    <h2 class="card-title"><i class="fas fa-server"></i> æœ¬åœ°å›¾åº“</h2>
                    <!-- ç¯å¢ƒåˆ‡æ¢å™¨ -->
                    <div class="env-selector" id="env-component" onclick="toggleDropdown()">
                        <span id="selected-env-text" class="env-badge">åŠ è½½ä¸­...</span>
                        <i class="fas fa-chevron-down"></i>
                        <div class="env-dropdown-list" id="env-dropdown-menu">
                            <a href="#" data-env="dev" class="env-dropdown-option"
                                onclick="selectEnvironment('dev'); event.stopPropagation();">å¼€å‘ç¯å¢ƒ</a>
                            <a href="#" data-env="test" class="env-dropdown-option"
                                onclick="selectEnvironment('test'); event.stopPropagation();">æµ‹è¯•ç¯å¢ƒ</a>
                            <a href="#" data-env="prod" class="env-dropdown-option"
                                onclick="selectEnvironment('prod'); event.stopPropagation();">ç”Ÿäº§ç¯å¢ƒ</a>
                        </div>
                    </div>
                </div>
                <p class="env-stats" id="envStats">
                    <span class="loading-text"><i class="fas fa-spinner fa-spin"></i> æ•°æ®åŒæ­¥ä¸­...</span>
                </p>
            </div>

            <div class="button-grid">
                <a href="/showPic" class="action-card primary">
                    <div class="icon-box"><i class="fas fa-random"></i></div>
                    <span class="label">éšæœºå›¾ç‰‡</span>
                </a>
                <a href="/randomGallery" class="action-card warm">
                    <div class="icon-box"><i class="fas fa-th-large"></i></div>
                    <span class="label">éšæœºç”»å»Š</span>
                </a>
                <a href="#" id="randomGroupBtn" class="action-card accent">
                    <div class="icon-box"><i class="fas fa-layer-group"></i></div>
                    <span class="label">éšæœºå¥—å›¾</span>
                </a>
                <a href="/groupList" class="action-card neutral">
                    <div class="icon-box"><i class="fas fa-list-ul"></i></div>
                    <span class="label">åˆ†ç»„åˆ—è¡¨</span>
                </a>
            </div>
        </div>

        <!-- æ¨¡å—äºŒï¼šç²¾é€‰æ”¶è— -->
        <div class="card module-card animate-fade-in delay-100">
            <div class="card-header">
                <div class="header-main">
                    <h2 class="card-title"><i class="fas fa-cloud-download-alt"></i> ç²¾é€‰æ”¶è—</h2>
                    <!-- éšç§æ¨¡å¼åˆ‡æ¢ (Inline) -->
                    <button class="privacy-btn" id="privacyToggle" onclick="togglePrivacy()" title="åˆ‡æ¢éšç§æ¨¡å¼">
                        <i class="fas fa-eye" id="privacyIcon"></i>
                        <span id="privacyText">éšç§æ¨¡å¼</span>
                    </button>
                </div>
                <p class="card-subtitle">XHS è§£æä¸ç²¾é€‰åŠ¨å›¾èµ„æº</p>
            </div>

            <div class="button-grid">
                <a href="/randomGif" class="action-card success" id="randomGifBtn">
                    <div class="icon-box"><i class="fas fa-film"></i></div>
                    <span class="label">éšæœºåŠ¨å›¾</span>
                </a>
                <a href="/downloadList" class="action-card info">
                    <div class="icon-box"><i class="fas fa-images"></i></div>
                    <span class="label">ä¸‹è½½æµè§ˆ</span>
                </a>
                <a href="/download" class="action-card warning" style="grid-column: span 2;">
                    <div class="icon-box"><i class="fas fa-file-download"></i></div>
                    <span class="label">å›¾ç‰‡ä¸‹è½½ç®¡ç†</span>
                </a>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let toastTimer;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            clearTimeout(toastTimer);
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            toastTimer = setTimeout(function () {
                toast.className = 'toast';
            }, 3000);
        }

        // Dropdown Logic - Restored to robust ID-based approach
        function toggleDropdown() {
            // Stop propagation if event is passed (defensive), but mainly rely on ID toggle
            const selector = document.getElementById('env-component');
            selector.classList.toggle('active');
        }

        function selectEnvironment(targetEnv) {
            // Dropdown closing is handled by parent click or outside click
            const selector = document.getElementById('env-component');
            selector.classList.remove('active');
            switchEnvironment(targetEnv);
        }

        // Close dropdown when clicking outside
        window.onclick = function (event) {
            const selector = document.getElementById('env-component');
            if (selector && !selector.contains(event.target)) {
                selector.classList.remove('active');
            }
        }

        async function updateEnvStatus() {
            try {
                // Get environment details
                const response = await fetch('/api/system/env/currentInfo');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                const data = result.data;
                const currentEnv = data.env;

                // Update Selector Text
                const selectedEnvText = document.getElementById('selected-env-text');
                const envMap = { dev: 'å¼€å‘ç¯å¢ƒ', test: 'æµ‹è¯•ç¯å¢ƒ', prod: 'ç”Ÿäº§ç¯å¢ƒ' };
                selectedEnvText.textContent = envMap[currentEnv] || "æœªçŸ¥ç¯å¢ƒ";

                // Update Active State in Menu
                document.querySelectorAll('.env-dropdown-option').forEach(item => {
                    if (item.dataset.env === currentEnv) item.classList.add('active');
                    else item.classList.remove('active');
                });

                // Update Stats
                const envStats = document.getElementById('envStats');
                envStats.innerHTML = `
                    <i class="fas fa-database"></i> åˆ†ç»„: ${data.groupCount || 0}
                    <span style="margin: 0 8px; color: var(--color-border);">|</span>
                    <i class="fas fa-image"></i> å›¾ç‰‡: ${data.picCount || 0}
                `;

            } catch (error) {
                console.error("Failed to get env status:", error);
                document.getElementById('selected-env-text').textContent = "è·å–å¤±è´¥";
                document.getElementById('envStats').innerHTML = '<span class="error-text">æ— æ³•è¿æ¥æœåŠ¡å™¨</span>';
            }
        }

        async function switchEnvironment(targetEnv) {
            const envMap = { dev: 'å¼€å‘ç¯å¢ƒ', test: 'æµ‹è¯•ç¯å¢ƒ', prod: 'ç”Ÿäº§ç¯å¢ƒ' };
            showToast(`æ­£åœ¨åˆ‡æ¢åˆ° ${envMap[targetEnv] || targetEnv}...`, 'info');
            try {
                const response = await fetch('/api/system/env/' + targetEnv);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                if (result.code === 200) {
                    await updateEnvStatus();
                    showToast(`ç¯å¢ƒå·²åˆ‡æ¢`, 'success');
                } else {
                    throw new Error(result.message || 'åˆ‡æ¢å¤±è´¥');
                }
            } catch (error) {
                console.error("Switch env failed:", error);
                showToast("åˆ‡æ¢å¤±è´¥: " + error.message, "error");
            }
        }

        document.addEventListener('DOMContentLoaded', updateEnvStatus);

        document.getElementById('randomGroupBtn').addEventListener('click', function (e) {
            e.preventDefault();
            fetch('/api/group/randomGroupInfo')
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200 && result.data && result.data.groupId) {
                        window.location.href = '/showPicList?groupId=' + result.data.groupId + '&groupName=' + encodeURIComponent(result.data.groupName || 'éšæœºå¥—å›¾');
                    } else {
                        window.location.href = '/showPicList';
                    }
                })
                .catch(() => window.location.href = '/showPicList');
        });

        // Theme Toggle
        function toggleTheme() {
            const newTheme = window.themeManager.toggle();
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.className = theme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
                themeIcon.parentElement.title = theme === 'light' ? 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼';
            }
        }

        // Privacy Mode Toggle
        async function togglePrivacy() {
            try {
                const btn = document.getElementById('privacyToggle');
                const icon = document.getElementById('privacyIcon');
                const isEnabled = icon.classList.contains('fa-eye'); // Currently visible -> requesting hidden (privacy enabled)

                const response = await fetch('/api/system/privacy-mode?enabled=' + isEnabled);
                if (response.ok) {
                    const result = await response.json();
                    if (result.code === 200) {
                        updatePrivacyIcon(isEnabled);
                        showToast(result.message, 'success');
                    } else {
                        showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
                    }
                }
            } catch (error) {
                console.error("Toggle privacy failed:", error);
                showToast("æ“ä½œå¤±è´¥", 'error');
            }
        }

        function updatePrivacyIcon(privacyEnabled) {
            const btn = document.getElementById('privacyToggle');
            const icon = document.getElementById('privacyIcon');
            const text = document.getElementById('privacyText');
            const gifBtn = document.getElementById('randomGifBtn');

            if (privacyEnabled) {
                // Privacy ON
                icon.className = 'fas fa-eye-slash';
                btn.classList.add('active');
                icon.style.color = '#ff6b6b';
                text.textContent = "éšç§å¼€å¯";
                btn.title = "å…³é—­éšç§æ¨¡å¼";

                // Disable GIF Button
                gifBtn.classList.add('disabled');
                gifBtn.removeAttribute('href'); // Remove link to ensure no navigation
            } else {
                // Privacy OFF
                icon.className = 'fas fa-eye';
                btn.classList.remove('active');
                icon.style.color = '';
                text.textContent = "éšç§æ¨¡å¼";
                btn.title = "å¼€å¯éšç§æ¨¡å¼";

                // Enable GIF Button
                gifBtn.classList.remove('disabled');
                gifBtn.setAttribute('href', '/randomGif');
            }
        }

        async function initPrivacyStatus() {
            try {
                const response = await fetch('/api/system/privacy-mode');
                if (response.ok) {
                    const result = await response.json();
                    if (result.code === 200) {
                        updatePrivacyIcon(result.data);
                    }
                }
            } catch (e) { }
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateThemeIcon(window.themeManager.get());
            initPrivacyStatus();
        });
    </script>

    <!-- PWA Service Worker æ³¨å†Œ -->
    <script>
        // Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);

                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('ğŸ”„ æ–°ç‰ˆæœ¬å¯ç”¨');
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('ğŸ’¡ PWA å¯ä»¥å®‰è£…åˆ°ä¸»å±å¹•');
            showInstallButton();
        });

        function showInstallButton() {
            const installHint = document.createElement('div');
            installHint.id = 'pwa-install-hint';
            installHint.innerHTML = `
        <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    color: white; padding: 12px 24px; border-radius: 30px; 
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; 
                    z-index: 1000; animation: slideUp 0.3s ease-out; 
                    font-size: 14px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-download"></i>
            <span>å®‰è£…åˆ°ä¸»å±å¹•</span>
        </div>
    `;

            const style = document.createElement('style');
            style.textContent = '@keyframes slideUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }';
            document.head.appendChild(style);

            installHint.onclick = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('âœ… ç”¨æˆ·æ¥å—äº†å®‰è£…');
                            showToast('æ­£åœ¨å®‰è£…...', 'success');
                        } else {
                            console.log('âŒ ç”¨æˆ·æ‹’ç»äº†å®‰è£…');
                        }
                        deferredPrompt = null;
                        installHint.remove();
                    });
                }
            };

            document.body.appendChild(installHint);

            setTimeout(() => {
                if (installHint.parentNode) {
                    installHint.style.opacity = '0';
                    installHint.style.transition = 'opacity 0.3s';
                    setTimeout(() => installHint.remove(), 300);
                }
            }, 10000);
        }

        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA å·²æˆåŠŸå®‰è£…åˆ°ä¸»å±å¹•');
            showToast('åº”ç”¨å·²å®‰è£…åˆ°ä¸»å±å¹•ï¼', 'success');
            const installHint = document.getElementById('pwa-install-hint');
            if (installHint) installHint.remove();
        });
    </script>

</body>

</html>