<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机图库 - 专业图片浏览平台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/theme.js"></script>
    <style>
        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1030;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-primary);
            font-size: var(--font-size-lg);
        }

        .theme-toggle:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-hover);
            transform: scale(1.05);
        }

        .theme-toggle i {
            transition: transform var(--transition-base);
        }

        .theme-toggle:hover i {
            transform: rotate(180deg);
        }

        .env-stats {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center; /* 新增：水平居中 */
            gap: 1.5rem; /* 调整间距更美观 */
            text-align: center; /* 确保文本居中 */
        }

        .env-stats i {
            margin-right: 0.3rem;
            color: var(--color-primary);
        }

        /* 确保副标题本身也是居中的（如果样式表中没有设置） */
        .card-subtitle {
            text-align: center;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>

<!-- 主题切换按钮 -->
<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="切换主题">
    <i class="fas fa-moon" id="themeIcon"></i>
</button>

<!-- 环境切换器 -->
<div class="dropdown" id="env-dropdown" style="position: fixed; top: 1.5rem; left: 1.5rem; z-index: 1030;">
    <div class="dropdown-toggle" onclick="toggleDropdown()">
        <span id="selected-env-text">加载中...</span>
        <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>
    <div class="dropdown-menu">
        <a href="#" data-env="dev" onclick="selectEnvironment('dev')" class="dropdown-item">开发环境</a>
        <a href="#" data-env="test" onclick="selectEnvironment('test')" class="dropdown-item">测试环境</a>
        <a href="#" data-env="prod" onclick="selectEnvironment('prod')" class="dropdown-item">生产环境</a>
    </div>
</div>

<!-- 主容器 -->
<div class="home-container">
    <div class="card home-card animate-fade-in">
        <div class="card-header">
            <h1 class="card-title">
                <i class="fas fa-images" style="margin-right: 0.5rem;"></i>
                随机图库
            </h1>
            <!-- 环境统计信息显示（已居中） -->
            <p class="env-stats" id="envStats">
                <i class="fas fa-spinner fa-spin"></i> 加载统计信息中...
            </p>
        </div>

        <div class="button-group">
            <a href="/showPic" class="btn btn-primary btn-full">
                <i class="fas fa-image"></i>
                <span>随机图片</span>
            </a>
            <a href="/randomGallery" class="btn btn-primary btn-full">
                <i class="fas fa-th"></i>
                <span>随机画廊</span>
            </a>
            <a href="/randomGif" class="btn btn-primary btn-full">
                <i class="fas fa-film"></i>
                <span>随机动图</span>
            </a>
            <a href="#" id="randomGroupBtn" class="btn btn-primary btn-full">
                <i class="fas fa-images"></i>
                <span>随机套图</span>
            </a>
            <a href="/groupList" class="btn btn-primary btn-full">
                <i class="fas fa-list"></i>
                <span>分组列表</span>
            </a>
            <a href="/download" class="btn btn-primary btn-full">
                <i class="fas fa-download"></i>
                <span>图片下载</span>
            </a>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    let toastTimer;

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        clearTimeout(toastTimer);
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        toastTimer = setTimeout(function(){
            toast.className = 'toast';
        }, 3000);
    }

    function toggleDropdown() {
        document.getElementById('env-dropdown').classList.toggle('open');
    }

    function selectEnvironment(targetEnv) {
        toggleDropdown();
        switchEnvironment(targetEnv);
    }

    async function updateEnvStatus() {
        try {
            // 调用新接口获取环境详情
            const response = await fetch('/api/system/env/currentInfo');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            const picCount = result.data; // PicCount对象
            const currentEnv = picCount.env;

            // 更新环境选择器显示
            const selectedEnvText = document.getElementById('selected-env-text');
            const envOptions = document.querySelectorAll('.dropdown-menu a');
            const envStats = document.getElementById('envStats');

            let found = false;
            envOptions.forEach(option => {
                const optionEnv = option.dataset.env;
                if (optionEnv === currentEnv) {
                    option.classList.add('active');
                    selectedEnvText.textContent = option.textContent;
                    found = true;
                } else {
                    option.classList.remove('active');
                }
            });

            if (!found) {
                selectedEnvText.textContent = "未知环境";
            }

            // 更新环境统计信息显示
            envStats.innerHTML = `
                <i class="fas fa-folder"></i> 分组总数: ${picCount.groupCount || 0}
                <i class="fas fa-image"></i> 图片总数: ${picCount.picCount || 0}
            `;

        } catch (error) {
            console.error("获取环境状态失败:", error);
            showToast("获取环境状态失败", "error");
            document.getElementById('selected-env-text').textContent = "获取失败";
            // 显示错误状态的统计信息（保持居中）
            document.getElementById('envStats').innerHTML =
                '<i class="fas fa-exclamation-circle"></i> 统计信息加载失败';
        }
    }

    async function switchEnvironment(targetEnv) {
        const envMap = { dev: '开发环境', test: '测试环境', prod: '生产环境' };
        showToast(`正在切换到 ${envMap[targetEnv] || targetEnv}...`, 'info');
        try {
            const response = await fetch('/api/system/env/' + targetEnv);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();

            if (result.code === 200) {
                await updateEnvStatus(); // 切换后重新获取环境详情
                const currentActiveButtonText = document.getElementById('selected-env-text').textContent;
                showToast(`成功切换到 ${currentActiveButtonText}！`, 'success');
            } else {
                throw new Error(result.message || '切换环境失败');
            }

        } catch (error) {
            console.error("切换环境失败:", error);
            showToast("切换环境失败: " + error.message, "error");
            await updateEnvStatus();
        }
    }

    document.addEventListener('DOMContentLoaded', updateEnvStatus);

    document.getElementById('randomGroupBtn').addEventListener('click', function(e) {
        e.preventDefault();
        fetch('/api/group/randomGroupInfo')
            .then(response => response.json())
            .then(result => {
                if (result.code === 200 && result.data && result.data.groupId) {
                    const groupId = result.data.groupId;
                    const groupName = result.data.groupName || '随机套图';
                    window.location.href = '/showPicList?groupId=' + groupId + '&groupName=' + encodeURIComponent(groupName);
                } else {
                    window.location.href = '/showPicList';
                }
            })
            .catch(error => {
                console.error('获取随机分组信息失败:', error);
                window.location.href = '/showPicList';
            });
    });

    window.onclick = function(event) {
        const dropdown = document.getElementById('env-dropdown');
        if (dropdown && !dropdown.contains(event.target)) {
            dropdown.classList.remove('open');
        }
    }

    // 主题切换功能
    function toggleTheme() {
        const newTheme = window.themeManager.toggle();
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
        const themeIcon = document.getElementById('themeIcon');
        if (themeIcon) {
            if (theme === 'light') {
                themeIcon.className = 'fas fa-sun';
                themeIcon.parentElement.title = '切换到深色模式';
            } else {
                themeIcon.className = 'fas fa-moon';
                themeIcon.parentElement.title = '切换到浅色模式';
            }
        }
    }

    // 页面加载时更新图标
    document.addEventListener('DOMContentLoaded', function() {
        const currentTheme = window.themeManager.get();
        updateThemeIcon(currentTheme);
    });
</script>
</body>
</html>