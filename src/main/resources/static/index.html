<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机图库</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="aurora-background"></div>

<div class="env-switcher">
    <div class="dropdown" id="env-dropdown">
        <div class="dropdown-toggle" onclick="toggleDropdown()">
            <span id="selected-env-text">加载中...</span>
            <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="dropdown-menu">
            <a href="#" data-env="dev" onclick="selectEnvironment('dev', '开发环境')">开发环境</a>
            <a href="#" data-env="test" onclick="selectEnvironment('test', '测试环境')">测试环境</a>
            <a href="#" data-env="prod" onclick="selectEnvironment('prod', '生产环境')">生产环境</a>
        </div>
    </div>
</div>

<div class="glass-container">
    <h1 class="text-4xl font-bold text-white mb-6">随机图库</h1>
    <div class="button-group">
        <a href="/showPic" class="btn btn-primary">获取随机图片</a>
        <a href="/showPicList" class="btn btn-primary">获取随机套图</a>
        <a href="/groupList" class="btn btn-primary">分组列表</a>
    </div>
</div>

<div id="toast"></div>

<script>
    let toastTimer;

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        clearTimeout(toastTimer);
        toast.textContent = message;
        toast.className = 'show ' + type;
        toastTimer = setTimeout(function(){
            toast.className = toast.className.replace('show', '');
        }, 3000);
    }

    /**
     * 切换下拉菜单的显示/隐藏
     */
    function toggleDropdown() {
        document.getElementById('env-dropdown').classList.toggle('open');
    }

    /**
     * 处理环境选择
     * @param {string} targetEnv - 'dev', 'test', 或 'prod'
     */
    function selectEnvironment(targetEnv) {
        // 立即关闭下拉菜单
        toggleDropdown();
        // 调用后端切换逻辑
        switchEnvironment(targetEnv);
    }

    /**
     * 获取当前环境并更新下拉菜单的状态
     */
    async function updateEnvStatus() {
        try {
            const response = await fetch('/getEnv');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const currentEnv = (await response.text()).trim();

            const selectedEnvText = document.getElementById('selected-env-text');
            const envOptions = document.querySelectorAll('.dropdown-menu a');

            let found = false;
            envOptions.forEach(option => {
                const optionEnv = option.dataset.env;
                if (optionEnv === currentEnv) {
                    option.classList.add('active'); // 激活当前选项
                    selectedEnvText.textContent = option.textContent; // 更新显示文本
                    found = true;
                } else {
                    option.classList.remove('active'); // 移除其他选项的激活状态
                }
            });

            if (!found) {
                selectedEnvText.textContent = "未知环境";
            }

        } catch (error) {
            console.error("获取环境状态失败:", error);
            showToast("获取环境状态失败", "error");
            document.getElementById('selected-env-text').textContent = "获取失败";
        }
    }

    /**
     * 切换环境的函数
     * @param {string} targetEnv - 目标环境
     */
    async function switchEnvironment(targetEnv) {
        const envMap = { dev: '开发环境', test: '测试环境', prod: '生产环境' };
        showToast(`正在切换到 ${envMap[targetEnv] || targetEnv} ...`);
        try {
            const response = await fetch('/' + targetEnv);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 切换成功后，重新获取最新环境并更新UI
            await updateEnvStatus();

            const currentActiveButtonText = document.getElementById('selected-env-text').textContent;
            showToast(`成功切换到 ${currentActiveButtonText}！`, 'success');

        } catch (error) {
            console.error("切换环境失败:", error);
            showToast("切换环境失败", "error");
            // 如果切换失败，刷新状态回退到真实环境
            await updateEnvStatus();
        }
    }

    // 页面加载完成后立即执行
    document.addEventListener('DOMContentLoaded', updateEnvStatus);

    // 点击页面其他地方关闭下拉菜单
    window.onclick = function(event) {
        const dropdown = document.getElementById('env-dropdown');
        // 检查点击的不是下拉菜单本身或其子元素
        if (dropdown && !dropdown.contains(event.target)) {
            dropdown.classList.remove('open');
        }
    }
</script>

</body>
</html>