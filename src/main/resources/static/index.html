<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºå›¾åº“ - ä¸“ä¸šå›¾ç‰‡æµè§ˆå¹³å°</title>

    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="éšæœºå›¾åº“">

    <!-- iOS å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">

    <!-- Android Chrome -->
    <link rel="icon" type="image/x-icon" sizes="192x192" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/theme.js"></script>
    <style>
        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1030;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-primary);
            font-size: var(--font-size-lg);
        }

        .theme-toggle:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-hover);
            transform: scale(1.05);
        }

        .theme-toggle i {
            transition: transform var(--transition-base);
        }

        .theme-toggle:hover i {
            transform: rotate(180deg);
        }

        .env-stats {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            /* æ–°å¢ï¼šæ°´å¹³å±…ä¸­ */
            gap: 1.5rem;
            /* è°ƒæ•´é—´è·æ›´ç¾è§‚ */
            text-align: center;
            /* ç¡®ä¿æ–‡æœ¬å±…ä¸­ */
        }

        .env-stats i {
            margin-right: 0.3rem;
            color: var(--color-primary);
        }

        /* ç¡®ä¿å‰¯æ ‡é¢˜æœ¬èº«ä¹Ÿæ˜¯å±…ä¸­çš„ï¼ˆå¦‚æœæ ·å¼è¡¨ä¸­æ²¡æœ‰è®¾ç½®ï¼‰ */
        .card-subtitle {
            text-align: center;
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body>

    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- ç¯å¢ƒåˆ‡æ¢å™¨ -->
    <div class="dropdown" id="env-dropdown" style="position: fixed; top: 1.5rem; left: 1.5rem; z-index: 1030;">
        <div class="dropdown-toggle" onclick="toggleDropdown()">
            <span id="selected-env-text">åŠ è½½ä¸­...</span>
            <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
        </div>
        <div class="dropdown-menu">
            <a href="#" data-env="dev" onclick="selectEnvironment('dev')" class="dropdown-item">å¼€å‘ç¯å¢ƒ</a>
            <a href="#" data-env="test" onclick="selectEnvironment('test')" class="dropdown-item">æµ‹è¯•ç¯å¢ƒ</a>
            <a href="#" data-env="prod" onclick="selectEnvironment('prod')" class="dropdown-item">ç”Ÿäº§ç¯å¢ƒ</a>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="home-container">
        <div class="card home-card animate-fade-in">
            <div class="card-header">
                <h1 class="card-title">
                    <i class="fas fa-images" style="margin-right: 0.5rem;"></i>
                    éšæœºå›¾åº“
                </h1>
                <!-- ç¯å¢ƒç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºï¼ˆå·²å±…ä¸­ï¼‰ -->
                <p class="env-stats" id="envStats">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ç»Ÿè®¡ä¿¡æ¯ä¸­...
                </p>
            </div>

            <div class="button-group">
                <a href="/showPic" class="btn btn-primary btn-full">
                    <i class="fas fa-image"></i>
                    <span>éšæœºå›¾ç‰‡</span>
                </a>
                <a href="/randomGallery" class="btn btn-primary btn-full">
                    <i class="fas fa-th"></i>
                    <span>éšæœºç”»å»Š</span>
                </a>
                <a href="/randomGif" class="btn btn-primary btn-full">
                    <i class="fas fa-film"></i>
                    <span>éšæœºåŠ¨å›¾</span>
                </a>
                <a href="#" id="randomGroupBtn" class="btn btn-primary btn-full">
                    <i class="fas fa-images"></i>
                    <span>éšæœºå¥—å›¾</span>
                </a>
                <a href="/groupList" class="btn btn-primary btn-full">
                    <i class="fas fa-list"></i>
                    <span>åˆ†ç»„åˆ—è¡¨</span>
                </a>
                <a href="/download" class="btn btn-primary btn-full">
                    <i class="fas fa-download"></i>
                    <span>å›¾ç‰‡ä¸‹è½½</span>
                </a>
                <a href="/downloadList" class="btn btn-primary btn-full">
                    <i class="fas fa-list"></i>
                    <span>ä¸‹è½½æµè§ˆ</span>
                </a>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let toastTimer;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            clearTimeout(toastTimer);
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            toastTimer = setTimeout(function () {
                toast.className = 'toast';
            }, 3000);
        }

        function toggleDropdown() {
            document.getElementById('env-dropdown').classList.toggle('open');
        }

        function selectEnvironment(targetEnv) {
            toggleDropdown();
            switchEnvironment(targetEnv);
        }

        async function updateEnvStatus() {
            try {
                // è°ƒç”¨æ–°æ¥å£è·å–ç¯å¢ƒè¯¦æƒ…
                const response = await fetch('/api/system/env/currentInfo');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                const picCount = result.data; // PicCountå¯¹è±¡
                const currentEnv = picCount.env;

                // æ›´æ–°ç¯å¢ƒé€‰æ‹©å™¨æ˜¾ç¤º
                const selectedEnvText = document.getElementById('selected-env-text');
                const envOptions = document.querySelectorAll('.dropdown-menu a');
                const envStats = document.getElementById('envStats');

                let found = false;
                envOptions.forEach(option => {
                    const optionEnv = option.dataset.env;
                    if (optionEnv === currentEnv) {
                        option.classList.add('active');
                        selectedEnvText.textContent = option.textContent;
                        found = true;
                    } else {
                        option.classList.remove('active');
                    }
                });

                if (!found) {
                    selectedEnvText.textContent = "æœªçŸ¥ç¯å¢ƒ";
                }

                // æ›´æ–°ç¯å¢ƒç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
                envStats.innerHTML = `
                <i class="fas fa-folder"></i> åˆ†ç»„æ€»æ•°: ${picCount.groupCount || 0}
                <i class="fas fa-image"></i> å›¾ç‰‡æ€»æ•°: ${picCount.picCount || 0}
            `;

            } catch (error) {
                console.error("è·å–ç¯å¢ƒçŠ¶æ€å¤±è´¥:", error);
                showToast("è·å–ç¯å¢ƒçŠ¶æ€å¤±è´¥", "error");
                document.getElementById('selected-env-text').textContent = "è·å–å¤±è´¥";
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¿æŒå±…ä¸­ï¼‰
                document.getElementById('envStats').innerHTML =
                    '<i class="fas fa-exclamation-circle"></i> ç»Ÿè®¡ä¿¡æ¯åŠ è½½å¤±è´¥';
            }
        }

        async function switchEnvironment(targetEnv) {
            const envMap = { dev: 'å¼€å‘ç¯å¢ƒ', test: 'æµ‹è¯•ç¯å¢ƒ', prod: 'ç”Ÿäº§ç¯å¢ƒ' };
            showToast(`æ­£åœ¨åˆ‡æ¢åˆ° ${envMap[targetEnv] || targetEnv}...`, 'info');
            try {
                const response = await fetch('/api/system/env/' + targetEnv);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                if (result.code === 200) {
                    await updateEnvStatus(); // åˆ‡æ¢åé‡æ–°è·å–ç¯å¢ƒè¯¦æƒ…
                    const currentActiveButtonText = document.getElementById('selected-env-text').textContent;
                    showToast(`æˆåŠŸåˆ‡æ¢åˆ° ${currentActiveButtonText}ï¼`, 'success');
                } else {
                    throw new Error(result.message || 'åˆ‡æ¢ç¯å¢ƒå¤±è´¥');
                }

            } catch (error) {
                console.error("åˆ‡æ¢ç¯å¢ƒå¤±è´¥:", error);
                showToast("åˆ‡æ¢ç¯å¢ƒå¤±è´¥: " + error.message, "error");
                await updateEnvStatus();
            }
        }

        document.addEventListener('DOMContentLoaded', updateEnvStatus);

        document.getElementById('randomGroupBtn').addEventListener('click', function (e) {
            e.preventDefault();
            fetch('/api/group/randomGroupInfo')
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200 && result.data && result.data.groupId) {
                        const groupId = result.data.groupId;
                        const groupName = result.data.groupName || 'éšæœºå¥—å›¾';
                        window.location.href = '/showPicList?groupId=' + groupId + '&groupName=' + encodeURIComponent(groupName);
                    } else {
                        window.location.href = '/showPicList';
                    }
                })
                .catch(error => {
                    console.error('è·å–éšæœºåˆ†ç»„ä¿¡æ¯å¤±è´¥:', error);
                    window.location.href = '/showPicList';
                });
        });

        window.onclick = function (event) {
            const dropdown = document.getElementById('env-dropdown');
            if (dropdown && !dropdown.contains(event.target)) {
                dropdown.classList.remove('open');
            }
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const newTheme = window.themeManager.toggle();
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                if (theme === 'light') {
                    themeIcon.className = 'fas fa-sun';
                    themeIcon.parentElement.title = 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
                } else {
                    themeIcon.className = 'fas fa-moon';
                    themeIcon.parentElement.title = 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼';
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°å›¾æ ‡
        document.addEventListener('DOMContentLoaded', function () {
            const currentTheme = window.themeManager.get();
            updateThemeIcon(currentTheme);
        });
    </script>

    <!-- PWA Service Worker æ³¨å†Œ -->
    <script>
        // Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);

                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('ğŸ”„ æ–°ç‰ˆæœ¬å¯ç”¨');
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('ğŸ’¡ PWA å¯ä»¥å®‰è£…åˆ°ä¸»å±å¹•');
            showInstallButton();
        });

        function showInstallButton() {
            const installHint = document.createElement('div');
            installHint.id = 'pwa-install-hint';
            installHint.innerHTML = `
        <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    color: white; padding: 12px 24px; border-radius: 30px; 
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; 
                    z-index: 1000; animation: slideUp 0.3s ease-out; 
                    font-size: 14px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-download"></i>
            <span>å®‰è£…åˆ°ä¸»å±å¹•</span>
        </div>
    `;

            const style = document.createElement('style');
            style.textContent = '@keyframes slideUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }';
            document.head.appendChild(style);

            installHint.onclick = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('âœ… ç”¨æˆ·æ¥å—äº†å®‰è£…');
                            showToast('æ­£åœ¨å®‰è£…...', 'success');
                        } else {
                            console.log('âŒ ç”¨æˆ·æ‹’ç»äº†å®‰è£…');
                        }
                        deferredPrompt = null;
                        installHint.remove();
                    });
                }
            };

            document.body.appendChild(installHint);

            setTimeout(() => {
                if (installHint.parentNode) {
                    installHint.style.opacity = '0';
                    installHint.style.transition = 'opacity 0.3s';
                    setTimeout(() => installHint.remove(), 300);
                }
            }, 10000);
        }

        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA å·²æˆåŠŸå®‰è£…åˆ°ä¸»å±å¹•');
            showToast('åº”ç”¨å·²å®‰è£…åˆ°ä¸»å±å¹•ï¼', 'success');
            const installHint = document.getElementById('pwa-install-hint');
            if (installHint) installHint.remove();
        });
    </script>

</body>

</html>